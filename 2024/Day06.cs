using System.Collections;

namespace _2024;

public static class Day06
{
    public static void Run()
    {
        Console.WriteLine("Example:\n");
        Execute(example);
        Console.WriteLine("\nProblem:\n");
        Execute(input);

        return;

        void Execute(string text)
        {
            var map = new Map(text);

            var originalPath = PathFinder.Navigate(map);
            var uniquePositions = originalPath.GetUniquePositions();
            Console.WriteLine($"Part 1: {uniquePositions.Count}");

            var totalPossibleObstructions = uniquePositions
                .AsParallel()
                .Count(obstacle =>
                    !PathFinder.Navigate(map.WithObstacle(obstacle)).Exits);

            Console.WriteLine($"Part 2: {totalPossibleObstructions}");
        }
    }

    internal enum Direction
    {
        North,
        South,
        East,
        West
    }

    internal readonly record struct Point(int X, int Y, int XMax, int YMax)
    {
        public bool IsInBounds =>
            (X >= 0 && X < XMax) && (Y >= 0 && Y < YMax);
    };

    internal readonly record struct Vector(Point Position, Direction Direction)
    {
        public static Vector FromStartingPoint(Point p) =>
            new(p, Direction.North);

        public Point DirectlyInFront => Direction switch
        {
            Direction.North => Position with { Y = Position.Y - 1 },
            Direction.South => Position with { Y = Position.Y + 1 },
            Direction.East => Position with { X = Position.X + 1 },
            Direction.West => Position with { X = Position.X - 1 },
            _ => throw new ArgumentOutOfRangeException()
        };

        public Vector Turn90Degrees() => this with
        {
            Direction = Direction switch
            {
                Direction.North => Direction.East,
                Direction.South => Direction.West,
                Direction.East => Direction.South,
                Direction.West => Direction.North,
                _ => throw new ArgumentOutOfRangeException()
            }
        };

        public Vector MoveForward() => this with
        {
            Position = DirectlyInFront
        };

        public bool IsInBounds => Position.IsInBounds;
    };

    internal record Map()
    {
        private readonly Point? _obstacle = null;
        private readonly char[][] _tiles = null!;

        public Map(string text) : this()
        {
            _tiles = text.Split(Environment.NewLine).Select(l => l.ToCharArray()).ToArray();
            var startingY = Array.FindIndex(_tiles, l => l.Any(c => c == '^'));
            var startingX = Array.FindIndex(_tiles[startingY], c => c == '^');

            Tiles = _tiles;
            Width = Tiles[0].Length;
            Height = Tiles.Length;
            StartingPoint = new(startingX, startingY, Width, Height);
        }

        private Map(Map map, Point obstacle) : this()
        {
            _obstacle = obstacle;
            _tiles = map.Tiles;

            Tiles = _tiles;
            Width = map.Width;
            Height = map.Height;
            StartingPoint = map.StartingPoint;
        }

        public Map WithObstacle(Point obstacle)
        {
            return new(this, obstacle);
        }

        public int Width { get; }

        public int Height { get; }

        public Point StartingPoint { get; }

        private char[][] Tiles { get; } = null!;

        public char this[Point p] => p == _obstacle ? '#' : _tiles[p.Y][p.X];
    }

    internal record Path : IEnumerable<Vector>
    {
        // The underlying collection to store vectors
        private readonly HashSet<Vector> _vectors;

        public Path(int capacity)
        {
            _vectors = new(capacity);
        }

        // Returns a HashSet of unique positions from the path
        public HashSet<Point> GetUniquePositions() =>
            _vectors.Select(v => v.Position).ToHashSet();

        // Implement ICollection<Vector> methods to maintain existing behavior
        public bool Add(Vector vector)
        {
            if (vector.IsInBounds) return _vectors.Add(vector);

            Exits = true;
            return false;
        }

        public bool Contains(Vector vector) => _vectors.Contains(vector);

        public int Count => _vectors.Count;
        public bool Exits { get; private set; }

        // Allows the Path to be enumerable
        public IEnumerator<Vector> GetEnumerator() => _vectors.GetEnumerator();
        IEnumerator IEnumerable.GetEnumerator() => GetEnumerator();
    }

    internal static class PathFinder
    {
        public static Path Navigate(Map map)
        {
            var vector = Vector.FromStartingPoint(map.StartingPoint);
            var path = new Path(map.Width * map.Height) { vector };

            while (vector.IsInBounds)
            {
                if (vector.DirectlyInFront.IsInBounds)
                {
                    while (map[vector.DirectlyInFront] == '#')
                    {
                        vector = vector.Turn90Degrees();
                    }
                }

                vector = vector.MoveForward();

                if (!path.Add(vector))
                    break;
            }

            return path;
        }
    }

    private const string example = """
                      ....#.....
                      .........#
                      ..........
                      ..#.......
                      .......#..
                      ..........
                      .#..^.....
                      ........#.
                      #.........
                      ......#...
                      """;
    private const string input = """
                    ......................#...#..............#.....................................#...#..............##..............................
                    ......#.....#................#....#...........#........#......................#...............................#.....#.#.###..#...#
                    ...#.#.................#........#.................#.........................................................#.....................
                    .....................................................................................................#.........#..................
                    .............................#.................#...................................#.....#....#........................#....#.....
                    ..........................#.....................................................................#..#.............#................
                    .................#...........................#..........................#..............................#.#..#...................#.
                    ..#....#....#......................................................................#....#.........................................
                    ..................................#............#...........#...........................................#.#....#.............#.#...
                    ...#...##....................................................................................#..........#..................#......
                    ..................#.....#......#.....#...#.........#..#.............................#....##.............#...............##.#..#...
                    ......#...............................................................................................................#..........#
                    ...........#................................#.......#.............#...............#...................................#...........
                    ............##...........................#........................................................................#...............
                    ...............................#........#...#.................................#..#.#.............#...........#....................
                    ........#..........#.#....................................................#........#....#..#.................................#....
                    .........#..............#........................#................................................................................
                    ..................#..........................#.............#..................#.#...........#.....#...............................
                    ...#...........#.#..........#.....................................................................................................
                    ..............#.................#.....................................................................#...#......#.....#..........
                    ..#.....#................................................................................................#.#.....#..........#.....
                    #.#..........#...#.............................#...............#..................................................#.#.............
                    ..........................#..#.............#................................................................................#.....
                    ...#..............................................................................................#..............#..#.......#.....
                    ........................................#......#........................................#...................##...........#........
                    .............#..............#...........................##...#............#.....#..#..............................................
                    ..#....#..#...............#........#.................#............................................#........##...............#.....
                    ................................................#.......#...........##.............................#.##...........................
                    ............................#..............#..#...........#...#.....#.#...................#.....#.............................#...
                    ....................#....................................................................................#........................
                    .......................................................................................#.......................##..#..............
                    #.............................#.............................................................#............................#........
                    ..............................................................................#.............#...#.........##......................
                    ...............#..........................#.............#............#...........................................#................
                    ................#........................#................................#...#............#.............................#........
                    ..............................................................#.....#..........#.......#........#....#..................#.........
                    ........................................................#..............................................................#.......#..
                    ..#........#............#........#...#.....#.......#..............................................................................
                    ..#..............#.#.....................................#..................................................#....##...............
                    ............#........................#..........##.................................................................#........#.....
                    ............#............#.#...............................................#.......#..............................................
                    ..................#.........................................#............................#......#..................#...........#..
                    ........................................................#.............##................................#........................#
                    .....................#...#......#.......#............#........#..................#...#.#....................................#.....
                    ...........................................................................................#..............................#....#..
                    ....#...................#.............#..........#..................................#.............................................
                    ......................................#...............................................#..#........................................
                    .................#..#............................................#.............................................................#.#
                    ............##...................................................................................#.........................#......
                    .........#.................................................#..#........................................#.....#..........#.....#...
                    .........#........................................................................................#.#...............#............#
                    ..........#..#...........#...................#.....#.......#......#....#..#.......................#..........#..........#.........
                    ......#...................................................#....#..............#....#.........##...#...............................
                    .........#........#........................#...........................................................#.......#................#.
                    .....................#...............................................#.##.........................................................
                    ................................................................................#.............#..............#............#.......
                    ......#..........#............................................#...#....................#...............................#.........#
                    ......................................#....#.........#..............................................................#...#.........
                    .......##...#.#..........................................................#............#...........#........#...................#..
                    .....#............................................................................#............................#..................
                    ....#..................#....#......#......#......................#......................#.......................................#.
                    ..#..............#..#............#.................................#............#..................#................#.............
                    ........................................................#....#...................................##.......................#.......
                    ..........#..................................#....#........#.......#..........................#................#...............#..
                    .....................................#.................#..................#...........#...........................................
                    .........#..............#...................................................................................#...................#.
                    .................##.................................#.......#.......................................................#.........#...
                    ...........#.................#..........................#...............................#..#...........................#..........
                    .....................................#...........................#...................#..............................#..#..........
                    .............................#.....#.................................................#.................##...............#.......#.
                    ............#.........................................................................................................#...........
                    ..........##.............#...................#.#...........................................#....................................##
                    ..........#..#...#...............#........#........................................................#.................#............
                    ....................#......................#....................................................#.#.....................#.........
                    .......................................#............#........................##............#....#..#..............................
                    ..........#..........#.....................................#.................................#.......#............................
                    ....#.............#...............................................................................................................
                    ..#..............................................#....#......#........................................#.................#.........
                    ...#......#.....#..............................#....#....................#......#..................#...................#.......#..
                    ...............#..#...........................##..................................................................................
                    ........#..#.....#.........................#.......#.............#..........................................#................#....
                    ...#......#.............#...............#.............................................................................##..........
                    #.................................#.......#.........#.#.#...................................#...#.#...........#..........#........
                    #.........#....#...#.........#.#.............................................................#....................................
                    ........................#.#.......#.................................................#.............................................
                    ...#...##...#..#...........................#.....#..........................#...............................#.......#.............
                    ................#..............................#..........##...................................................................#..
                    .......................................................................#...#..#...#.....#....#..................##..........#.....
                    #.....................#.........#........#.....................................................................#.....#.......#....
                    ...........#......................#.......#.................................................#........................#............
                    .......#.........................................#.....#...#...........#................#....#......#...........#......#..........
                    ....#.............#...............................#...#....#..#..#...........................................#.............#......
                    ...#.........#..........................................#.....#...........^.#...#....#...........................#................
                    .....#..#...............#...........................#.#..........#........................................................#.......
                    .............#.......#.............................................................................................#...#..........
                    ..#...................#...............................#......#............#...........#.......#...................................
                    ...........#.......................#..........#...#.......................#..............#.............##.............#..#........
                    ..#............#.............#.......................................................#.....##....................................#
                    .#.........#.....................................................................#.........#......................................
                    .............#....................................................................#.....#.............#...#...........#..........#
                    ..........................#.....#...#......................#.................................#.....#.................#.......#....
                    ..........#.#.....................................................................................................................
                    ............#.......#....................#.......#.............................................#..................................
                    .......................................#..#........#...................................................#..........................
                    ...................#........#....#........#..................#..........................................................#.........
                    ........#..............#....................#............#......#...........#.....#..............................#.........#......
                    .......#.....#.................#.#..#..............................................................#.......#..#...........#......#
                    .#....................##.....................................................#...#.....#..........................................
                    ...........#..................#.....#....#............#...............#....#............#.......................#.................
                    ........#.....................................#......##............#..........................#..........#....................#...
                    ..........................#...............................................................#.......................................
                    ......................#..................................#.....................#.............................................#...#
                    .........#..............................................................#........##.........#.......#.............................
                    ....#...#........#...........#....#.............#............#.....#..............................................................
                    ...........#...............................................................................................#.......#..#...........
                    ........#..........................#............................#...........#............#.............................#..........
                    .......#...........................#...#...............#..#..#...................#.........#......................................
                    ..#..............................#........#...........#.......................................#...#...............................
                    .............#...#.............#.........#...........#.....................................#................#.....................
                    .........................#..........................#.................................#...........................................
                    ..................##.............#........#......#............#........................#.......#......................#....#......
                    .....#............................................................................................................................
                    .#..................................#.....#.............#...#.............................................#..............#..##..#.
                    ...............#........................................................#.........#..#..........#.........................#.......
                    .............................................#...................#.................#..................#......................#....
                    ............................#.......................................................................................#.............
                    ............#...............#....................#....#..........#..#..............................#......#.......#.......##......
                    ............#.................................................................................#...................................
                    ........................#...............................................................#......#.......#.......#.......###......#.
                    ......................................#.#.........................................#.....#.............................#.........#.
                    """;
}

public static class Day06_2
{
    public static void Run()
    {
        var example = """
                      ....#.....
                      .........#
                      ..........
                      ..#.......
                      .......#..
                      ..........
                      .#..^.....
                      ........#.
                      #.........
                      ......#...
                      """;
        var input = """
                    ......................#...#..............#.....................................#...#..............##..............................
                    ......#.....#................#....#...........#........#......................#...............................#.....#.#.###..#...#
                    ...#.#.................#........#.................#.........................................................#.....................
                    .....................................................................................................#.........#..................
                    .............................#.................#...................................#.....#....#........................#....#.....
                    ..........................#.....................................................................#..#.............#................
                    .................#...........................#..........................#..............................#.#..#...................#.
                    ..#....#....#......................................................................#....#.........................................
                    ..................................#............#...........#...........................................#.#....#.............#.#...
                    ...#...##....................................................................................#..........#..................#......
                    ..................#.....#......#.....#...#.........#..#.............................#....##.............#...............##.#..#...
                    ......#...............................................................................................................#..........#
                    ...........#................................#.......#.............#...............#...................................#...........
                    ............##...........................#........................................................................#...............
                    ...............................#........#...#.................................#..#.#.............#...........#....................
                    ........#..........#.#....................................................#........#....#..#.................................#....
                    .........#..............#........................#................................................................................
                    ..................#..........................#.............#..................#.#...........#.....#...............................
                    ...#...........#.#..........#.....................................................................................................
                    ..............#.................#.....................................................................#...#......#.....#..........
                    ..#.....#................................................................................................#.#.....#..........#.....
                    #.#..........#...#.............................#...............#..................................................#.#.............
                    ..........................#..#.............#................................................................................#.....
                    ...#..............................................................................................#..............#..#.......#.....
                    ........................................#......#........................................#...................##...........#........
                    .............#..............#...........................##...#............#.....#..#..............................................
                    ..#....#..#...............#........#.................#............................................#........##...............#.....
                    ................................................#.......#...........##.............................#.##...........................
                    ............................#..............#..#...........#...#.....#.#...................#.....#.............................#...
                    ....................#....................................................................................#........................
                    .......................................................................................#.......................##..#..............
                    #.............................#.............................................................#............................#........
                    ..............................................................................#.............#...#.........##......................
                    ...............#..........................#.............#............#...........................................#................
                    ................#........................#................................#...#............#.............................#........
                    ..............................................................#.....#..........#.......#........#....#..................#.........
                    ........................................................#..............................................................#.......#..
                    ..#........#............#........#...#.....#.......#..............................................................................
                    ..#..............#.#.....................................#..................................................#....##...............
                    ............#........................#..........##.................................................................#........#.....
                    ............#............#.#...............................................#.......#..............................................
                    ..................#.........................................#............................#......#..................#...........#..
                    ........................................................#.............##................................#........................#
                    .....................#...#......#.......#............#........#..................#...#.#....................................#.....
                    ...........................................................................................#..............................#....#..
                    ....#...................#.............#..........#..................................#.............................................
                    ......................................#...............................................#..#........................................
                    .................#..#............................................#.............................................................#.#
                    ............##...................................................................................#.........................#......
                    .........#.................................................#..#........................................#.....#..........#.....#...
                    .........#........................................................................................#.#...............#............#
                    ..........#..#...........#...................#.....#.......#......#....#..#.......................#..........#..........#.........
                    ......#...................................................#....#..............#....#.........##...#...............................
                    .........#........#........................#...........................................................#.......#................#.
                    .....................#...............................................#.##.........................................................
                    ................................................................................#.............#..............#............#.......
                    ......#..........#............................................#...#....................#...............................#.........#
                    ......................................#....#.........#..............................................................#...#.........
                    .......##...#.#..........................................................#............#...........#........#...................#..
                    .....#............................................................................#............................#..................
                    ....#..................#....#......#......#......................#......................#.......................................#.
                    ..#..............#..#............#.................................#............#..................#................#.............
                    ........................................................#....#...................................##.......................#.......
                    ..........#..................................#....#........#.......#..........................#................#...............#..
                    .....................................#.................#..................#...........#...........................................
                    .........#..............#...................................................................................#...................#.
                    .................##.................................#.......#.......................................................#.........#...
                    ...........#.................#..........................#...............................#..#...........................#..........
                    .....................................#...........................#...................#..............................#..#..........
                    .............................#.....#.................................................#.................##...............#.......#.
                    ............#.........................................................................................................#...........
                    ..........##.............#...................#.#...........................................#....................................##
                    ..........#..#...#...............#........#........................................................#.................#............
                    ....................#......................#....................................................#.#.....................#.........
                    .......................................#............#........................##............#....#..#..............................
                    ..........#..........#.....................................#.................................#.......#............................
                    ....#.............#...............................................................................................................
                    ..#..............................................#....#......#........................................#.................#.........
                    ...#......#.....#..............................#....#....................#......#..................#...................#.......#..
                    ...............#..#...........................##..................................................................................
                    ........#..#.....#.........................#.......#.............#..........................................#................#....
                    ...#......#.............#...............#.............................................................................##..........
                    #.................................#.......#.........#.#.#...................................#...#.#...........#..........#........
                    #.........#....#...#.........#.#.............................................................#....................................
                    ........................#.#.......#.................................................#.............................................
                    ...#...##...#..#...........................#.....#..........................#...............................#.......#.............
                    ................#..............................#..........##...................................................................#..
                    .......................................................................#...#..#...#.....#....#..................##..........#.....
                    #.....................#.........#........#.....................................................................#.....#.......#....
                    ...........#......................#.......#.................................................#........................#............
                    .......#.........................................#.....#...#...........#................#....#......#...........#......#..........
                    ....#.............#...............................#...#....#..#..#...........................................#.............#......
                    ...#.........#..........................................#.....#...........^.#...#....#...........................#................
                    .....#..#...............#...........................#.#..........#........................................................#.......
                    .............#.......#.............................................................................................#...#..........
                    ..#...................#...............................#......#............#...........#.......#...................................
                    ...........#.......................#..........#...#.......................#..............#.............##.............#..#........
                    ..#............#.............#.......................................................#.....##....................................#
                    .#.........#.....................................................................#.........#......................................
                    .............#....................................................................#.....#.............#...#...........#..........#
                    ..........................#.....#...#......................#.................................#.....#.................#.......#....
                    ..........#.#.....................................................................................................................
                    ............#.......#....................#.......#.............................................#..................................
                    .......................................#..#........#...................................................#..........................
                    ...................#........#....#........#..................#..........................................................#.........
                    ........#..............#....................#............#......#...........#.....#..............................#.........#......
                    .......#.....#.................#.#..#..............................................................#.......#..#...........#......#
                    .#....................##.....................................................#...#.....#..........................................
                    ...........#..................#.....#....#............#...............#....#............#.......................#.................
                    ........#.....................................#......##............#..........................#..........#....................#...
                    ..........................#...............................................................#.......................................
                    ......................#..................................#.....................#.............................................#...#
                    .........#..............................................................#........##.........#.......#.............................
                    ....#...#........#...........#....#.............#............#.....#..............................................................
                    ...........#...............................................................................................#.......#..#...........
                    ........#..........................#............................#...........#............#.............................#..........
                    .......#...........................#...#...............#..#..#...................#.........#......................................
                    ..#..............................#........#...........#.......................................#...#...............................
                    .............#...#.............#.........#...........#.....................................#................#.....................
                    .........................#..........................#.................................#...........................................
                    ..................##.............#........#......#............#........................#.......#......................#....#......
                    .....#............................................................................................................................
                    .#..................................#.....#.............#...#.............................................#..............#..##..#.
                    ...............#........................................................#.........#..#..........#.........................#.......
                    .............................................#...................#.................#..................#......................#....
                    ............................#.......................................................................................#.............
                    ............#...............#....................#....#..........#..#..............................#......#.......#.......##......
                    ............#.................................................................................#...................................
                    ........................#...............................................................#......#.......#.......#.......###......#.
                    ......................................#.#.........................................#.....#.............................#.........#.
                    """;

        Console.WriteLine("Example:\n");
        Execute(example);
        Console.WriteLine("\nProblem:\n");
        Execute(input);

        return;

        void Execute(string text)
        {
            var map = text.Split(Environment.NewLine).Select(l => l.ToList()).ToList();
            var (width, height) = (map.First().Count, map.Count);
            var startingY = map.FindIndex(l => l.Any(c => c == '^'));
            var startingX = map[startingY].FindIndex(c => c == '^');
            var startingPoint = new Point(startingX, startingY, width, height);
            var vector = Vector.FromStartingPoint(startingPoint);
            HashSet<Point> visitedPoints = [startingPoint];

            while (vector.Position.IsInBounds)
            {
                var inFront = vector.DirectlyInFront;
                if (inFront.IsInBounds)
                {
                    var obstacle = map[inFront.Y][inFront.X];

                    if (obstacle == '#')
                    {
                        vector = vector.Turn90Degrees();
                    }
                }

                vector = vector.MoveForward();

                if (vector.Position.IsInBounds)
                    visitedPoints.Add(vector.Position);
            }

            Console.WriteLine($"Part 1: {visitedPoints.Count}");

            var totalPossiblePositions = 0;
            var visited = new HashSet<Vector>(width * height);

            foreach (var (x, y) in visitedPoints)
            {
                if (map[y][x] != '.') continue;

                var replacePoint = new Point(x, y, width, height);
                vector = Vector.FromStartingPoint(startingPoint);
                visited.Clear();
                visited.Add(vector);

                while (vector.Position.IsInBounds)
                {
                    var somethingIsInTheWay = true;
                    do
                    {
                        if (!vector.DirectlyInFront.IsInBounds) continue;
                        var obstacle = vector.DirectlyInFront == replacePoint ? '#' : map[vector.DirectlyInFront.Y][vector.DirectlyInFront.X];

                        if (obstacle == '#')
                        {
                            vector = vector.Turn90Degrees();
                        }
                        else
                        {
                            somethingIsInTheWay = false;
                        }
                    } while (somethingIsInTheWay && vector.DirectlyInFront.IsInBounds);

                    vector = vector.MoveForward();

                    if (visited.Add(vector)) continue;

                    totalPossiblePositions++;
                    break;
                }
            }

            Console.WriteLine($"Part 2: {totalPossiblePositions}");
        }
    }

    private enum Direction
    {
        North,
        South,
        East,
        West
    }

    private record Point(int X, int Y, int XMax, int YMax)
    {
        public bool IsInBounds =>
            (X >= 0 && X < XMax) && (Y >= 0 && Y < YMax);

        internal void Deconstruct(out int x, out int y)
        {
            x = X;
            y = Y;
        }
    };

    private record Vector(Point Position, Direction Direction)
    {
        public static Vector FromStartingPoint(Point p) =>
            new(p, Direction.North);

        public Point DirectlyInFront => Direction switch
        {
            Direction.North => Position with { Y = Position.Y - 1 },
            Direction.South => Position with { Y = Position.Y + 1 },
            Direction.East => Position with { X = Position.X + 1 },
            Direction.West => Position with { X = Position.X - 1 },
            _ => throw new ArgumentOutOfRangeException()
        };

        public Vector Turn90Degrees() => this with
        {
            Direction = Direction switch
            {
                Direction.North => Direction.East,
                Direction.South => Direction.West,
                Direction.East => Direction.South,
                Direction.West => Direction.North,
                _ => throw new ArgumentOutOfRangeException()
            }
        };

        public Vector MoveForward() => this with
        {
            Position = DirectlyInFront
        };
    };
}